!function(){"use strict";function e(e,o,i,n,c,a,l,r,p,d,u,m,h,g,f,k,v){function T(){var e=p.cache;for(var t in e.nm_comment){var s=e.nm_comment[t].correlationId;for(var o in e.postTaskGoingList)e.postTaskGoingList[o].id==s&&(e.postTaskGoingList[o].ui_showPassive2Badge=!0)}}var S=r.vm={};S.tabsetSpace=ionic.Platform.isAndroid()?"44px":"64px",S.contentSpace=ionic.Platform.isAndroid()?"84px":"104px",S.state=o,S.IMInterfaceService=k,S._isClicking=!1;var b=function(){return 0==S._isClicking&&(u(function(){S._isClicking=!1},300),S._isClicking=!0,!0)};S.tabSelectedIndex=0,S.postTabSelectedIndex=0,S.acceptTabSelectedIndex=0,S.taskScroll=l.$getByHandle("taskScroll"),S.pollIntervalTime=t,S.lastPollErrorOccurMS=0,S.isNetSynchronizing=!1,S.timeChecker=new Date,S.badges={postGoing:0,postFinish:0,acceptGoing:0,acceptFinish:0};var _=g.getNoticeMessageTypes(),L=function(){var e=p.cache;e.nm_task_changed&&(e.nm_task_changed=!1,S.badges.postGoing=e.nm_postGoing.length+e.nm_comment.length,S.badges.postFinish=e.nm_postFinish.length,S.badges.acceptGoing=e.nm_acceptGoing.length,S.badges.acceptFinish=e.nm_acceptFinish.length,T()),0==S.tabSelectedIndex?0==S.postTabSelectedIndex?0!=S.badges.postGoing&&(h.setReadFlagByType(_.POSTER_UNCOMPLETED_TASK_MESSAGE_TYPE),e.nm_postGoing=[],e.nm_main_changed=!0,S.badges.postGoing=e.nm_comment.length):0!=S.badges.postFinish&&(e.nm_postFinish=[],e.nm_main_changed=!0,S.badges.postFinish=0):0==S.acceptTabSelectedIndex?0!=S.badges.acceptGoing&&(h.setReadFlagByType(_.ACCEPTER_UNCOMPLETED_TASK_MESSAGE_TYPE),e.nm_acceptGoing=[],e.nm_main_changed=!0,S.badges.acceptGoing=0):0!=S.badges.acceptFinish&&(h.setReadFlagByType(_.ACCEPTER_COMPLETED_TASK_MESSAGE_TYPE),e.nm_acceptFinish=[],e.nm_main_changed=!0,S.badges.acceptFinish=0),1!=S.isNetSynchronizing&&(G(),(S.lastPollErrorOccurMS>0||S.timeChecker.getTime()-S.lastPollErrorOccurMS>s+2e3)&&(m.remove(0,"task",L),m.add(1,"task",L)))};r.$on("$ionicView.enter",function(){p.cache.isPostTaskGoingNeedRefresh&&p.cache.isPostTaskFinishNeedRefresh&&p.cache.isAcceptTaskGoingNeedRefresh&&p.cache.isAcceptTaskFinishNeedRefresh&&(S.isNetSynchronizing=!0,i.show(),p.getTaskList().then(function(e){S.repeatList=e.uncompletedPostList,I(e.uncompletedPostList,!0),T(),I(e.completedPostList,!0),I(e.uncompletedAcceptList,!1),I(e.completedAcceptList,!1),S.taskScroll.scrollTop(),u(function(){r.$apply()})},y)["finally"](function(){i.hide(),S.isNetSynchronizing=!1})),m.add(0,"task.controller",L)}),r.$on("$ionicView.leave",function(){m.remove(0,"task.controller",L),m.remove(1,"task.controller",L)});var y=function(e){console.error(e),S.pollIntervalTime=s,S.lastPollErrorOccurMS=(new Date).getTime()},I=function(e,t){if(1==t)for(var s in e)e[s].ui_identifier=null!=e[s].accepter?"联系援助人":"",e[s].ui_nickname=null!=e[s].accepter?e[s].accepter.nickname:"神秘大侠",e[s].ui_userId=null!=e[s].accepter?e[s].accepter.userId:"",e[s].ui_avatar=null!=e[s].accepter?e[s].accepter.avatar:"",e[s].ui_taskIcon=d.iconByTypeValue(e[s].taskTypesId),e[s].ui_taskTypeName=d.nameByTypeValue(e[s].taskTypesId),d.taskStateToUiState(e[s],e[s].status,!0);else for(var s in e)e[s].ui_identifier="联系求助人",e[s].ui_nickname=e[s].poster.nickname,e[s].ui_userId=null!=e[s].poster?e[s].poster.userId:"",e[s].ui_avatar=e[s].poster.avatar,e[s].ui_taskIcon=d.iconByTypeValue(e[s].taskTypesId),e[s].ui_taskTypeName=d.nameByTypeValue(e[s].taskTypesId),d.taskStateToUiState(e[s],e[s].status,!1)},P=function(){1==p.cache.isPostTaskGoingNeedRefresh&&(i.show(),S.isNetSynchronizing=!0,p.getUncompletedPostTaskList().then(function(e){I(e,!0),T(),0==S.tabSelectedIndex&&0==S.postTabSelectedIndex&&(S.repeatList=e,S.taskScroll.scrollTop()),i.hide(),u(function(){r.$apply()})},y)["finally"](function(){S.isNetSynchronizing=!1}))},x=function(){1==p.cache.isPostTaskFinishNeedRefresh&&(i.show(),S.isNetSynchronizing=!0,p.getCompletedPostTaskList(1,15).then(function(e){I(e,!0),0==S.tabSelectedIndex&&1==S.postTabSelectedIndex&&(S.repeatList=e,S.taskScroll.scrollTop()),i.hide(),u(function(){r.$apply()})},y)["finally"](function(){S.isNetSynchronizing=!1}))},w=function(){1==p.cache.isAcceptTaskGoingNeedRefresh&&(i.show(),S.isNetSynchronizing=!0,p.getUncompletedAcceptTaskList().then(function(e){I(e,!1),1==S.tabSelectedIndex&&0==S.postTabSelectedIndex&&(S.repeatList=e,S.taskScroll.scrollTop()),i.hide(),u(function(){r.$apply()})},y)["finally"](function(){S.isNetSynchronizing=!1}))},C=function(){1==p.cache.isAcceptTaskFinishNeedRefresh&&(i.show(),S.isNetSynchronizing=!0,p.getCompletedAcceptTaskList(1,15).then(function(e){I(e,!1),1==S.tabSelectedIndex&&1==S.postTabSelectedIndex&&(S.repeatList=e,S.taskScroll.scrollTop()),i.hide(),u(function(){r.$apply()})},y)["finally"](function(){S.isNetSynchronizing=!1}))},G=function(){P(),x(),w(),C()};S.cb_post=function(){console.log("post"),S.tabSelectedIndex=0,a.getWidgetStatic("hoTabSet","task").last=0,0==ho.isValid(S.hasClicked_cb_post)?S.hasClicked_cb_post=!0:0==S.postTabSelectedIndex?S.cb_taskPostGoing():S.cb_taskPostFinish()},S.cb_accept=function(){console.log("accept"),S.tabSelectedIndex=1,a.getWidgetStatic("hoTabSet","task").last=1,0==S.acceptTabSelectedIndex?S.cb_taskAcceptGoing():S.cb_taskAcceptFinish()},S.cb_taskPostGoing=function(){S.postTabSelectedIndex=0,0==ho.isValid(S.hasClicked_cb_taskPostGoing)?S.hasClicked_cb_taskPostGoing=!0:(S.repeatList=p.cache.postTaskGoingList,P()),S.taskScroll.scrollTop()},S.cb_taskPostFinish=function(){S.postTabSelectedIndex=1,S.repeatList=p.cache.postTaskFinishList,C(),S.taskScroll.scrollTop()},S.cb_taskAcceptGoing=function(){S.acceptTabSelectedIndex=0,0==ho.isValid(S.hasClicked_cb_taskAcceptGoing)?S.hasClicked_cb_taskAcceptGoing=!0:(S.repeatList=p.cache.acceptTaskGoingList,w()),S.taskScroll.scrollTop()},S.cb_taskAcceptFinish=function(){S.acceptTabSelectedIndex=1,S.repeatList=p.cache.acceptTaskFinishList,C(),S.taskScroll.scrollTop()},S.doRefresh=function(){p.getTaskList().then(function(e){S.repeatList=e.uncompletedPostList,I(e.uncompletedPostList,!0),I(e.completedPostList,!0),I(e.uncompletedAcceptList,!1),I(e.completedAcceptList,!1),0==S.tabSelectedIndex&&0==S.postTabSelectedIndex?S.repeatList=e.uncompletedPostList:0==S.tabSelectedIndex&&1==S.postTabSelectedIndex?S.repeatList=e.completedPostList:1==S.tabSelectedIndex&&0==S.acceptTabSelectedIndex?S.repeatList=e.uncompletedAcceptList:1==S.tabSelectedIndex&&1==S.acceptTabSelectedIndex&&(S.repeatList=e.completedAcceptList),S.taskScroll.scrollTop()},y)["finally"](function(){r.$broadcast("scroll.refreshComplete")})},S.cb_gotoUser=function(e){b()&&f.gotoUser(e,"task")},S.cb_taskState=function(e){b()&&N(S.repeatList[e].id)};var N=function(e){o.go("main.task-state",{id:e})},A=function(e,t){o.go("main.comment",{desc:t+"-"+e})};S.gotoComment=function(e){b()&&o.go("main.comment",{desc:"accepter-"+e})},S.cb_contact=function(e){0!=b()&&n.show({titleText:"联系Ta",buttons:[{text:"<b>发消息</b>"},{text:"<b>打电话</b>"}],buttonClicked:function(t){var s,o=S.repeatList[e];return 0==S.tabSelectedIndex?s=o.poster:1==S.tabSelectedIndex?s=o.accepter:ho.alert("tabindex invalid"),0==t?f.gotoIM(s.userId):1==t&&(v.location.href="tel:"+s.phoneNo),!0},cancelText:"取消",cancel:function(){},destructiveButtonClicked:function(){}})},S.opt_passive=function(e){if(0!=b()){var t=S.repeatList[e];0==S.tabSelectedIndex?0==t.status?(i.show(),p.cancelByPoster(t.id).then(function(e){console.log(e),200==e.code&&(i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-cancel-success.html"}),u(function(){p.cache.isPostTaskFinishNeedRefresh=!0,p.cache.isPostTaskGoingNeedRefresh=!0},1500))},function(e){i.hide(),c.alert({title:"错误提示",template:e}).then(function(t){console.error(e)})})["finally"](function(){})):2==t.status?console.error("invalid task opt: wait over time - post passive"):4==t.status?console.error("invalid task opt: going on - post passive"):8==t.status?console.error("invalid task opt: going on overtime - post passive"):32==t.status?console.error("invalid task opt: accepter cancel - post passive"):64==t.status?(i.show(),p.confirmByPoster(t.id,256).then(function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isPostTaskFinishNeedRefresh=!0},1500)},function(e,t){c.alert({title:"错误提示",template:e}).then(function(t){console.error(e)})})["finally"](function(){})):128==t.status?console.error("invalid task opt: poster confirm success - post passive"):256==t.status&&console.error("invalid task opt: poster confirm failed - post passive"):0==t.status?console.error("invalid task opt: wait - accepter passive"):2==t.status?console.error("invalid task opt: wait over time - accepter passive"):4==t.status?(console.error("invalid task opt: going on - accepter passive"),i.show(),p.cancelByAcceptor(t.id).then(function(e,t){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isAcceptTaskFinishNeedRefresh=!0},1500)},function(e){i.hide(),c.alert({title:"错误提示",template:e}).then(function(t){console.error(e)})})["finally"](function(){})):8==t.status?console.error("invalid task opt: going on overtime -accepter post passive"):32==t.status?console.error("invalid task opt: accepter cancel - accepter passive"):64==t.status?console.error("invalid task opt: accepter confirm success  - accepter passive"):128==t.status?N(t.id):256==t.status&&N(t.id)}},S.opt_passive2=function(e){if(0!=b()){var t=S.repeatList[e];0==S.tabSelectedIndex?0==t.status?(o.go("main.task_task-detail",{id:t.id}),p.setCommentReadFlag(t.id),p.cache.nm_main_changed=!0,p.cache.nm_task_changed=!0):2==t.status?console.log("大侠召唤术"):4==t.status?console.error("invalid task opt: going on - post passive"):8==t.status?A(t.id,"poster"):32==t.status?0==t.posterCommentLevel?A(t.id,"poster"):N(t.id):64==t.status?(i.show(),p.confirmByPoster(t.id,128).then(function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isPostTaskGoingNeedRefresh=!0},1500)},function(e,t){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-fail.html"}),ho.alert(e)})["finally"](function(){})):128==t.status?0==t.posterCommentLevel?A(t.id,"poster"):N(t.id):256==t.status&&(0==t.posterCommentLevel?A(t.id,"poster"):N(t.id)):0==t.status?console.error("invalid task opt: waiting - accepter active"):2==t.status?console.error("invalid task opt: wait over time - accepter active"):4==t.status?(i.show(),p.completeByAcceptor(t.id).then(function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isAcceptTaskGoingNeedRefresh=!0},1500)},function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-fail.html"}),ho.alert(e)})["finally"](function(){})):8==t.status?A(t.id,"accepter"):32==t.status?N(t.id):64==t.status?console.error("invalid task opt: accepter confirm success - accepter active"):128==t.status?0==t.accepterCommentLevel?A(t.id,"accepter"):N(t.id):256==t.status&&(0==t.accepterCommentLevel?A(t.id,"accepter"):N(t.id))}},S.opt_active=function(e){if(0!=b()){var t=S.repeatList[e];0==S.tabSelectedIndex?0==t.status||(2==t.status?console.log("大侠召唤术"):4==t.status?console.error("invalid task opt: going on - post passive"):8==t.status?A(t.id,"poster"):32==t.status?0==t.posterCommentLevel?A(t.id,"poster"):N(t.id):64==t.status?(i.show(),p.confirmByPoster(t.id,128).then(function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isPostTaskGoingNeedRefresh=!0},1500)},function(e,t){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-fail.html"}),ho.alert(e)})["finally"](function(){})):128==t.status?0==t.posterCommentLevel?A(t.id,"poster"):N(t.id):256==t.status&&(0==t.posterCommentLevel?A(t.id,"poster"):N(t.id))):0==t.status?console.error("invalid task opt: waiting - accepter active"):2==t.status?console.error("invalid task opt: wait over time - accepter active"):4==t.status?(i.show(),p.completeByAcceptor(t.id).then(function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-success.html"}),u(function(){p.cache.isAcceptTaskGoingNeedRefresh=!0},1500)},function(e){i.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/com-submit-fail.html"}),ho.alert(e)})["finally"](function(){})):8==t.status?A(t.id,"accepter"):32==t.status?N(t.id):64==t.status?console.error("invalid task opt: accepter confirm success - accepter active"):128==t.status?0==t.accepterCommentLevel?A(t.id,"accepter"):N(t.id):256==t.status&&(0==t.accepterCommentLevel?A(t.id,"accepter"):N(t.id))}}}angular.module("main.task").controller("mainTaskCtrl",["$log","$state","$ionicLoading","$ionicActionSheet","$ionicPopup","widgetDelegate","$ionicScrollDelegate","$scope","taskNetService","taskUtils","$timeout","intervalCenter","NoticeMessageDB","NoticeMessageService","userUtils","IMInterfaceService","$window",e]);var t=200,s=5e3}();