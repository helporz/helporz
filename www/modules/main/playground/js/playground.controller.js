!function(){"use strict";function o(o,t,e,i){var n=o.vm={};n.gotoGroup=function(o){t.go("topic-group",{groupId:o})},n.slideList=[{groupId:1,pic:"img/intro/jieshao1@2x.png"},{groupId:2,pic:"img/intro/jieshao2@2x.png"},{groupId:3,pic:"img/intro/jieshao3@2x.png"},{groupId:4,pic:"img/intro/jieshao4@2x.png"}],n.groupList=i.getGroupInfoList()}function t(o,t,e,i,n,c,r,a,l,s,p,u,m,d,g,f,C,L,h,v){var T=t.vm={};"undefined"==typeof e.groupId||null==e.groupId?T.groupId=1:T.groupId=e.groupId,T.state=i,T.IMInterfaceService=h,T.topicGroup=u.getGroupInfo(T.groupId),T.sysTopicList=p.getSysTopicList(T.groupId),T.userTopicList=p.getTopicList(T.groupId),T.isCanLoadMore=!0,T.adList=p.getADList(),T.gotoAD=function(o){v.getTopicDetailInfo(o.actionUrl,0,0,10).then(function(t){p.setCurrentDetailTopic(t.topic),p.setCurrentDetailTopicCommentList(t.commentList),i.go("main.topic-group_topic-detail",{topicId:o.actionUrl})},function(o){})},T.moreDataCanBeLoaded=function(){return!(null==T.userTopicList||!T.isCanLoadMore)},t.$on("$destroy",function(){T.popover.remove()}),t.$on("popover.hidden",function(){T.popover.hide()}),t.$on("popover.removed",function(){T.popover.remove()}),t.$on("$ionicView.beforeEnter",function(){null!=T.userTopicList&&0!=T.userTopicList.length||(s.show(),T.doRefresh().then(function(){s.hide()},function(){s.hide()}))});var $=t.$new();$.cancel=T.hidePopover,T.gotoOwnTopic=function(){i.go("main.topic-group_own-topic-list"),T.hidePopover()},T.gotoCollectionTopic=function(){i.go("main.topic-group_collection-topic-list"),T.hidePopover()},T.gotoMyMessageList=function(){i.go("main.topic-group_my-message-list"),T.hidePopover()},T.gotoMyCommentList=function(){i.go("main.topic-group_my-comment-list"),T.hidePopover()},T.go2AddTopic=function(){T.hidePopover();var o=t.$new();o.onRefresh=function(){s.show(),T.doRefresh().then(function(){s.hide()},function(){s.hide()})},o.groupId=T.groupId,l.fromTemplateUrl("modules/main/playground/templates/topic-publish.html",{scope:o,animation:"slide-in-up"}).then(function(o){f.setPublishModal(o),o.show()})},T.go2TopicDetail=function(o){p.setCurrentDetailTopic(o),i.go("main.topic-group_topic-detail",{topicId:o.id})},$.gotoOwnTopic=T.gotoOwnTopic,$.gotoCollectionTopic=T.gotoCollectionTopic,$.gotoMyMessageList=T.gotoMyMessageList,$.gotoMyCommentList=T.gotoMyCommentList,$.go2AddTopic=T.go2AddTopic,a.fromTemplateUrl("modules/main/playground/templates/topic-group-popover.html",{title:null,subTitle:null,scope:$}).then(function(o){T.popover=o}),T.hidePopover=function(){T.popover.hide()},T.showPopover=function(o){T.popover.show(o)},T.showImgs=function(o){for(var e=t.$new(),i=new Array,n=0;n<o.length;++n){var c={imgSrc:o[n]};i.push(c)}e.imgList=i,l.fromTemplateUrl("modules/main/playground/templates/show-imgs.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,o.show()})},T.shareTopic=function(o){p.shareTopic(o)},T.favouriteToggle=function(o){0==o.isFavourite?g.addFavouriteTopic(o.id,o.groupId,o.created).then(function(t){o.isFavourite=!0,++o.favouriteCount},function(o){n.error(o)}):g.deleteFavouriteTopic(o.id,o.groupId,o.created).then(function(t){o.isFavourite=!1,--o.favouriteCount},function(o){n.error(o)})},T.loadMore=function(){var o=T.userTopicList.length;p.moreTopic(T.groupId).then(function(e){T.userTopicList=e,0!=e.length&&o!=e.length||(T.isCanLoadMore=!1),t.$broadcast("scroll.infiniteScrollComplete")},function(o){t.$broadcast("scroll.infiniteScrollComplete")})},T.doRefresh=function(){var e=o.defer();return p.refreshSysTopic(T.groupId).then(function(o){T.sysTopicList=o,p.refreshTopic(T.groupId).then(function(o){t.$broadcast("scroll.refreshComplete"),T.userTopicList=o,T.isCanLoadMore=!0;for(var i in T.userTopicList){var n=T.userTopicList[i];n.ui_tags=[],C.netTagsToUiTags(n.ui_tags,n.poster.tags)}e.resolve()},function(o){t.$broadcast("scroll.refreshComplete"),e.reject()})},function(o){t.$broadcast("scroll.refreshComplete"),e.reject()}),e.promise},T.filterTopic=function(o){m.addFilterTopic(o.id,o.groupId,o.created).then(function(t){o.isShow=!1},function(o){n.error(o)})},T.addTopic2BlackList=function(o){d.addTopicBlacklist(o.id).then(function(t){o.isShow=!1},function(o){n.error(o)})},T.moreOpt=function(o){r.show({titleText:"选择",buttons:[{text:"不想看到本条目"},{text:"举报"}],cancelText:"取消",cancel:function(){console.log("CANCELLED")},buttonClicked:function(t){return console.log("BUTTON CLICKED",t),0==t?T.filterTopic(o):1==t&&T.addTopic2BlackList(o),!0}})},T.cb_gotoUser=function(o){L.gotoUser(o,"topic-group")}}function e(o,t,e,i,n,c,r,a,l,s,p,u,m,d,g,f){var C=this,L=[];C.imgList=L;var h=1,v=4;C.maxImgCount=v,C.tagList=[],C.selectedCount=0;var T=f.getTopicTagList();if(null!=T)for(var $=0;$<T.length;++$){var S={base:T[$],selected:!1};C.tagList.push(S)}C.toggleSelected=function(o){1==o.selected?(o.selected=!1,C.selectedCount--):C.selectedCount<3&&(o.selected=!0,C.selectedCount++)},C.closeModal=function(){var o=u.getPublishModal();o.remove()},C.clickCamera=function(){r.show({titleText:"",buttons:[{text:"打开照相机"},{text:"从手机相册获取"}],cancelText:"取消",cancel:function(){console.log("CANCELLED")},buttonClicked:function(o){return console.log("BUTTON CLICKED",o),0==o?C.openCamera():1==o&&C.openAlbum(),!0}})},C.clickImg=function(o){r.show({buttons:[{text:"查看照片"},{text:"删除照片"}],cancelText:"取消",cancel:function(){},buttonClicked:function(t){return 0==t?C.showImg(o):1==t&&C.delImg(o),!0}})},C.showImg=function(o){var e=t.$new();e.imgList=C.imgList,s.fromTemplateUrl("modules/main/playground/templates/show-imgs.html",{scope:e,animation:"slide-in-up"}).then(function(o){e.modal=o,o.show()})},C.addImg=function(o,t){var e={id:h++,imgSrc:o,nativeUrl:t};L.push(e),n.info("image list length:"+L.length)},C.delImg=function(o){n.info("delImg id:"+o.id);for(var t=0;t<L.length;++t)if(L[t].id==o.id){L.splice(t,1);break}n.info("imgList length:"+L.length)},C.openCamera=function(){var o=C.setOptions(Camera.PictureSourceType.CAMERA);navigator.camera.getPicture(function(o){n.info("imageData length:"+o.length),n.info("image file url:"+o),resolveLocalFileSystemURL(o,function(e){n.info("image cvd file:"+e.toInternalURL()),C.addImg(e.toInternalURL(),o),t.$apply()})},function(o){alert(o)},o)},C.setOptions=function(o){var t={quality:100,destinationType:Camera.DestinationType.FILE_URI,targetWidth:800,targetHeight:800,sourceType:o,encodingType:Camera.EncodingType.JPEG,mediaType:Camera.MediaType.PICTURE,allowEdit:!1,correctOrientation:!0};return t},C.openAlbum=function(){var o={maximumImagesCount:v-C.imgList.length+1,width:800,height:800,quality:80};l.getPictures(o).then(function(o){for(var e=!1,i=0;i<o.length;++i)n.info("picker get picture url:"+o[i]),i==o.length-1&&(e=!0),resolveLocalFileSystemURL(o[i],function(o){n.info("image cvd file:"+o.toInternalURL()),C.addImg(o.toInternalURL(),o.toNativeURL()),e&&(n.info("call $scope.$apply()"),t.$apply())})})},C.clearContent=function(){null!=C.content&&""!=C.content&&c.confirm({title:"提示",subTitle:"请确定清空内容",cancelText:"取消",okText:"确定"}).then(function(o){o&&(C.content="")})},C.publish=function(){for(var e=t.groupId,i=new Array,n=0;n<C.tagList.length;++n)1==C.tagList[n].selected&&i.push(C.tagList[n].base);m.addTopic(e,C.content,C.imgList.length,0,i).then(function(e){for(var i=e.data,n=new Array,c={Connection:"close","x-login-key":g.getLoginTicket()},r=0;r<C.imgList.length;++r){var a=d.uploadImgFile(L[r].nativeUrl,appConfig.API_SVC_URL+"/playground/topic/"+i+"/img/"+r,c);null!=a&&n.push(a)}p.all(n).then(function(){alert("发布话题成功"),C.closeModal(),o(function(){t.onRefresh()})},function(){alert("发布话题失败，上传图片失败")})},function(o){alert("发布话题失败")})}}function i(o,t,e,i,n,c,r,a,l,s,p,u,m,d,g,f,C){var L=t.vm={};L.topicService=s,L.topicId=e.topicId,l.show(),L.topic=s.getCurrentDetailTopic(),null==L.topic&&(L.topic={id:L.topicId,poster:{}}),s.setCurrentDetailTopic(null),L.topic.ui_tags=[],g.netTagsToUiTags(L.topic.ui_tags,L.topic.poster.tags),L.topicCommentList=s.getCurrentDetailTopicCommentList(),s.setCurrentDetailTopicCommentList(null),L.collectionTopicService=u,t.$on("$ionicView.beforeEnter",function(){null!=L.topicCommentList&&0==L.topicCommentList.length?L.doRefresh().then(function(){l.hide()},function(){l.hide()}):l.hide()}),L.cb_gotoUser=function(o){0!=C.canClick()&&f.gotoUser(o,"topic-group")},L.refreshCommentList=function(){var o=a.defer();return p.getTopicCommentList(L.topicId,0,1,10).then(function(t){L.topicCommentList=t,o.resolve(t)},function(t){o.reject(t)}),o.promise},L.showImgs=function(e){for(var i=t.$new(),n=new Array,c=0;c<e.length;++c){var r={imgSrc:e[c]};n.push(r)}i.imgList=n,o.fromTemplateUrl("modules/main/playground/templates/show-imgs.html",{scope:i,animation:"slide-in-up"}).then(function(o){i.modal=o,o.show()})},L.setCommentFocus=function(o){L.isComment=new Object,L.isComment.content=new Date,L.replyCommentItem=null,o.stopPropagation()},L.setReplyCommentFocus=function(o,t){L.isComment=new Object,L.isComment.content=new Date,L.replyCommentItem=o,t.stopPropagation()},L.clearReplyComment=function(){L.isComment=!1,L.replyCommentItem=null},L.sendComment=function(o){var e,i,n;null!=L.replyCommentItem?(e=L.replyCommentItem.id,i=L.replyCommentItem.commentSessionId,n=L.replyCommentItem.commenter.userId):n=L.topic.poster.userId,l.show(),p.addTopicComment(L.topic.id,L.sendContent,i,e,n).then(function(o){L.doRefresh().then(function(){c(function(){t.$apply(),l.hide()})},function(){l.hide()}),L.sendContent=null},function(o){l.hide()})},L.doRefresh=function(){var o=a.defer();return p.getTopicDetailInfo(L.topic.id,0,1,10).then(function(e){L.topic=e.topic,L.topicCommentList=e.commentList,c(function(){t.$apply(),t.$broadcast("scroll.refreshComplete"),o.resolve()})},function(e){t.$broadcast("scroll.refreshComplete"),o.reject()}),o.promise},L.loadMore=function(){var o=L.topic.id,e=null!=L.topicCommentList&&L.topicCommentList.length>0?L.topicCommentList[0].id:0,i=10,n=null!=L.topicCommentList?Math.ceil(L.topicCommentList.length/i)+1:1;p.getTopicCommentList(o,e,n,i).then(function(o){null==L.topicCommentList?L.topicCommentList=o:L.topicCommentList=L.topicCommentList.concat(o),c(function(){t.$apply()}),t.$broadcast("scroll.infiniteScrollComplete")},function(o){t.$broadcast("scroll.infiniteScrollComplete")})},L.moreDataCanBeLoaded=function(){return null!=L.topicCommentList&&!(L.topicCommentList.length>=L.topic.commentCount)},L.collectionToggle=function(o){u.isCollectionTopic(L.topicId)?u.cancelCollectionTopic(L.topicId).then(function(){alert("取消收藏成功")},function(){alert("取消收藏失败")}):u.addCollectionTopic(L.topicId).then(function(){alert("收藏成功")},function(){alert("收藏失败")})},L.addTopic2BlackList=function(o){m.addTopicBlacklist(o.id).then(function(t){o.isShow=!1},function(o){n.error(o)})},L.operateTopic=function(){r.show({titleText:"选择",buttons:[{text:"举报"}],cancelText:"取消",cancel:function(){console.log("CANCELLED")},buttonClicked:function(o){return console.log("BUTTON CLICKED",o),L.addTopic2BlackList(L.topic),!0}})},L.operateComment=function(o,t){0!=C.canClick()&&r.show({titleText:"选择",buttons:[{text:"举报"},{text:"回复"}],cancelText:"取消",cancel:function(){console.log("CANCELLED")},buttonClicked:function(e){return console.log("BUTTON CLICKED",e),0==e?p.addComment2Blacklist(L.topic.groupId,L.topicId,o.id):1==e&&L.setReplyCommentFocus(o,t),!0}})},L.favouriteToggle=function(){0==L.topic.isFavourite?d.addFavouriteTopic(L.topic.id,L.topic.groupId,L.topic.created).then(function(o){L.topic.isFavourite=!0,++L.topic.favouriteCount},function(o){n.error(o)}):d.deleteFavouriteTopic(L.topic.id,L.topic.groupId,L.topic.created).then(function(o){L.topic.isFavourite=!1,--L.topic.favouriteCount},function(o){n.error(o)})}}function n(o,t,e,i,n,c,r,a,l){var s=o.vm={};s.commentSessionId=t.sessionId,s.pageSize=20,s.canLoadMoreData=!1,o.$on("$ionicView.afterEnter",function(){s.topicCommentList=null,s.loadMoreCommentList()}),s.loadMoreCommentList=function(){var t=null!=s.topicCommentList?Math.ceil(s.topicCommentList.length/s.pageSize)+1:1;l.getTopicCommentListBySessionId(s.commentSessionId,t,s.pageSize).then(function(t){null==s.topicCommentList?s.topicCommentList=t:t.length>0&&(s.topicCommentList=s.topicCommentList.concat(t)),t.length<s.pageSize?s.canLoadMoreData=!1:s.canLoadMoreData=!0,o.$broadcast("scroll.infiniteScrollComplete")},function(t){o.$broadcast("scroll.infiniteScrollComplete")})},s.moreDataCanBeLoaded=function(){return s.canLoadMoreData}}function c(o,t,e,i,n,c,r,a,l){var s=o.vm={};s.pageSize=20,s.canLoadMoreData=!1,o.$on("$ionicView.afterEnter",function(){s.topicList=null,s.loadMoreTopicList()}),s.cb_gotoUser=function(o){l.gotoUser(o,"topic-group")},s.loadMoreTopicList=function(){var t=null!=s.topicList?Math.ceil(s.topicList.length/s.pageSize)+1:1;a.getOwnTopicListByUser(0,t,s.pageSize).then(function(t){null==s.topicList?s.topicList=t:t.length>0&&(s.topicList=s.topicList.concat(t)),t.length<s.pageSize?s.canLoadMoreData=!1:s.canLoadMoreData=!0,o.$broadcast("scroll.infiniteScrollComplete")},function(t){o.$broadcast("scroll.infiniteScrollComplete")})},s.moreDataCanBeLoaded=function(){return s.canLoadMoreData},s.go2TopicDetail=function(o){r.setCurrentDetailTopic(o),t.go("main.topic-group_topic-detail",{topicId:o.id})}}function r(o,t,e,i,n,c,r,a,l){var s=o.vm={};s.pageSize=20,s.canLoadMoreData=!1,o.$on("$ionicView.afterEnter",function(){s.topicList=null,s.loadMoreTopicList()}),s.cb_gotoUser=function(o){l.gotoUser(o,"topic-group")},s.loadMoreTopicList=function(){var t=null!=s.topicList?Math.ceil(s.topicList.length/s.pageSize)+1:1;a.getCollectionTopicListByUser(t,s.pageSize).then(function(t){null==s.topicList?s.topicList=t:t.length>0&&(s.topicList=s.topicList.concat(t)),t.length<s.pageSize?s.canLoadMoreData=!1:s.canLoadMoreData=!0,o.$broadcast("scroll.infiniteScrollComplete")},function(t){o.$broadcast("scroll.infiniteScrollComplete")})},s.moreDataCanBeLoaded=function(){return s.canLoadMoreData},s.go2TopicDetail=function(o){r.setCurrentDetailTopic(o),t.go("main.topic-group_topic-detail",{topicId:o.id})}}function a(o,t,e,i,n,c,r,a,l){var s=o.vm={};s.pageSize=20,s.canLoadMoreData=!1,o.$on("$ionicView.afterEnter",function(){s.topicCommentList=null,s.loadMoreCommentList()}),s.cb_gotoUser=function(o){l.gotoUser(o,"topic-group")},s.loadMoreCommentList=function(){var t=null!=s.topicCommentList?Math.ceil(s.topicCommentList.length/s.pageSize)+1:1;a.getTopicCommentListByUser(t,s.pageSize).then(function(t){null==s.topicCommentList?s.topicCommentList=t:t.length>0&&(s.topicCommentList=s.topicCommentList.concat(t)),t.length<s.pageSize?s.canLoadMoreData=!1:s.canLoadMoreData=!0,o.$broadcast("scroll.infiniteScrollComplete")},function(t){o.$broadcast("scroll.infiniteScrollComplete")})},s.moreDataCanBeLoaded=function(){return s.canLoadMoreData},s.go2TopicDetail=function(o){r.setCurrentDetailTopic(o),t.go("main.topic-group_topic-detail",{topicId:o.id})}}function l(o,t,e,i,n,c,r,a,l){var s=o.vm={};s.pageSize=20,s.canLoadMoreData=!1,o.$on("$ionicView.afterEnter",function(){s.topicCommentList=null,s.loadMoreCommentList()}),s.cb_gotoUser=function(o){l.gotoUser(o,"topic-group")},s.loadMoreCommentList=function(){var t=null!=s.topicCommentList?Math.ceil(s.topicCommentList.length/s.pageSize)+1:1;a.getReplyMessageListByUserId(t,s.pageSize).then(function(t){null==s.topicCommentList?s.topicCommentList=t:t.length>0&&(s.topicCommentList=s.topicCommentList.concat(t)),t.length<s.pageSize?s.canLoadMoreData=!1:s.canLoadMoreData=!0,o.$broadcast("scroll.infiniteScrollComplete")},function(t){o.$broadcast("scroll.infiniteScrollComplete")})},s.moreDataCanBeLoaded=function(){return s.canLoadMoreData},s.go2TopicDetail=function(o){r.setCurrentDetailTopic(o),t.go("main.topic-group_topic-detail",{topicId:o.id})}}function s(){var o=function(o){var t="";for(var e in o)t+="#"+o[e].name+"#",t+="  ";return t};return o}angular.module("com.helporz.playground").controller("topicGroupController",t).controller("topicDetailController",i).controller("topicPublishController",e).controller("playgroundListController",o).controller("ownTopicListController",c).controller("collectionTopicListController",r).controller("myCommentListController",a).controller("myMessageListController",l).controller("commentSessionController",n).filter("TagConnector",s),o.$inject=["$scope","$state","$log","topicGroupService"],t.$inject=["$q","$scope","$stateParams","$state","$log","$timeout","$ionicActionSheet","$ionicPopover","$ionicModal","$ionicLoading","topicService","topicGroupService","filterTopicService","topicBlacklistService","favouriteTopicService","topicModalService","impressUtils","userUtils","IMInterfaceService","PlaygroundNetService"],e.$inject=["$timeout","$scope","$stateParams","$state","$log","$ionicPopup","$ionicActionSheet","$cordovaCamera","$cordovaImagePicker","$ionicModal","$q","topicModalService","PlaygroundNetService","uploadService","userLoginInfoService","topicService"],i.$inject=["$ionicModal","$scope","$stateParams","$state","$log","$timeout","$ionicActionSheet","$q","$ionicLoading","topicService","PlaygroundNetService","collectionTopicService","topicBlacklistService","favouriteTopicService","impressUtils","userUtils","operationUtils"],n.$inject=["$scope","$stateParams","$state","$log","$timeout","$ionicActionSheet","$q","topicService","PlaygroundNetService"],c.$inject=["$scope","$state","$log","$timeout","$ionicActionSheet","$q","topicService","PlaygroundNetService","userUtils"],r.$inject=["$scope","$state","$log","$timeout","$ionicActionSheet","$q","topicService","PlaygroundNetService","userUtils"],a.$inject=["$scope","$state","$log","$timeout","$ionicActionSheet","$q","topicService","PlaygroundNetService","userUtils"],l.$inject=["$scope","$state","$log","$timeout","$ionicActionSheet","$q","topicService","PlaygroundNetService","userUtils"]}();