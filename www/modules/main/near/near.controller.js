!function(){"use strict";function e(e,t,a,n,i,s,c,o,r,l,u,f,m,d,h){function p(e){c.cache.nearTaskList=e,s.vm.items=e;for(var t=0;t<s.vm.items.length;t++){var a=s.vm.items[t];a.icon=r.iconByTypeValue(a.taskTypesId),a.typeName=r.nameByTypeValue(a.taskTypesId),a.commentCount=a.commentList?a.commentList.length:0,a.ui_isMyTask=o.cache.selfInfo.userId==a.poster.userId;var n=a.created.split(/[\:\-\s]/);6!=n.length&&alert("network err: task created time is not valid");var f=new Date(n[0],parseInt(n[1])-1,n[2],n[3],n[4],n[5]);a.ui_createTime=l.formatSimpleTimeBeforeNow(f),a.ui_tags=[],u.netTagsToUiTags(a.ui_tags,a.poster.tags)}i(function(){s.$apply()})}function k(e){alert("main.near"+e)}function g(){a.show(),c.queryNewTaskList().then(p,k)["finally"](function(){a.hide()})}var v=!1,T=function(){return 0==v&&(i(function(){v=!1},300),v=!0,!0)},N=s.vm={};N.state=e,N.IMInterfaceService=h,N.sharePageService=m,N.doRefresh=function(){c.queryNewTaskList().then(p,k)["finally"](function(){s.$broadcast("scroll.refreshComplete")})};var y=function(){c.cache.isNearTaskNeedRefresh&&(c.cache.isNearTaskNeedRefresh=!1,g())};s.$on("$ionicView.enter",function(){ho.isValid(o.cache.selfInfo)&&(N.orgName=o.cache.selfInfo.orgList[0].name),f.add(0,"near",y)}),s.$on("$ionicView.leave",function(){f.remove(0,"near",y)}),N.cb_itemClick=function(t){0!=T()&&e.go("main.task-detail",{id:N.items[t].id})},N.cb_gotoUser=function(e){0!=T()&&d.gotoUser(e,"near")},N.cb_acceptTask=function(e){if(0!=T()){var t=c.cache.nearTaskList[e];a.show(),c.acceptTask(t.id).then(function(e){200==e.code?(a.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/task-accept-success.html"}),i(function(){c.cache.isNearTaskNeedRefresh=!0,c.cache.isAcceptTaskGoingNeedRefresh=!0},1500)):(a.show({duration:1500,templateUrl:"modules/components/templates/ionic-loading/task-not-exist.html"}),i(function(){c.cache.isNearTaskNeedRefresh=!0},1500))},function(){})["finally"](function(){console.log("accept taskid="+t.id)})}}}angular.module("main.near").controller("mainNearCtrl",["$state","$log","$ionicLoading","$interval","$timeout","$scope","taskNetService","userNetService","taskUtils","timeUtils","impressUtils","intervalCenter","SharePageWrapService","userUtils","IMInterfaceService",e])}();