!function(e){"use strict;";function r(e,r,o,i,n,t,c){e.phoneno="",e.smscode="",e.submitLogin=function(o){var s=e.smscode,a=e.phoneno;console.log(a),i.show({template:"登录中..."}),n.login(a,s).then(function(){i.hide(),""!=t.cache.selfInfo.avatar?(r.go("main.near"),c.observeNoticeMessage(),c.fetchNoticeMessage()):r.go("info")},function(e){i.hide(),alert(e)})}}function o(e,r,o,i,n,t,c,s,a,l,u,f,g,v,d,m,p){function h(e){var o=r.defer();o.resolve(e.data.ticket);var i={};return a.saveLoginInfo(e.data.ticket,i),o.promise}function S(e){var o=r.defer();return o.reject("访问服务器失败，网络状态码为"+e),o.promise}function y(e){return N=e,l.getSelfInfoForPromise()}function I(e){var o=r.defer();return o.reject(e),o.promise}function L(e){var o=r.defer();return a.saveLoginInfo(N,e),p.initService(e.userId).then(function(){return u.loginForPromise(e.imLoginName,e.imPassword)},function(e){i.error("init im interface service failed:"+e);var o=r.defer();return o.reject(e),o.promise}).then(function(){i.info("登录IM成功"),o.resolve()},function(r){i.error("登录IM失败 #loginName# #password#:#error#".replace("#loginName#",e.imLoginName).replace("#password#",e.imPassword).replace("#error#",r)),g_isDebug?o.resolve():o.reject(r)}),o.promise}var N,k=function(e,r){var o=t.getDeviceInfo(),i=l.login(o.type,e,r,JSON.stringify(o));return w(i)},$=function(){var e=r.defer(),o=a.getLoginTicket();if(null==o||""===o)return e.reject(),e.promise;var i=t.getDeviceInfo(),n=v.getDateToString(new Date,"yyyy-MM-dd HH:mm:ss"),c=l.loginByTicket(o,n,JSON.stringify(i));return w(c)},w=function(o){var i=r.defer();return o.then(h,S).then(y,I).then(L,I).then(function(){var r=a.getLoginInfo().userInfo.userId;g.initService(r),m.initService(r),e.clearHistory(),i.resolve()},function(e){i.reject()}),i.promise},j=function(){var o=r.defer(),i=a.getLoginTicket();return null==i||""===i?(o.resolve,o.promise):(l.logout(i,"sign").then(function(){u.logout(),a.clear(),o.resolve(),e.clearHistory()},function(){u.logout(),a.clear(),o.resolve(),e.clearHistory()}),o.promise)},C=function(){var e=a.getLoginTicket();return null!=e&&""!==e},b=function(){return a.isShowIntro()};return{login:k,loginByTicket:$,isLogging:C,isShowIntro:b,logout:j}}angular.module("com.helporz.login",["ngCordova","com.helporz.utils.service","com.helporz.user.netservice","com.helporz.jim.services","com.helporz.playground","com.helporz.task.netservice","com.helporz.task.noticemessage"]).factory("loginService",o).controller("loginCtrl",r).directive("getsmscode",["$http","$log","pushService",function(e,r,o){return{restrict:"E",replace:!0,template:'<button class="button button-small" >发送验证码</button>',link:function(i,n,t){console.log(n),n.bind("click",function(n){var t=i.phoneno;console.log(t);var c={type:2,os:"android",version:"1.0",hid:"111",imsi:"123",serial:""};"undefined"!=typeof device?(c.os=device.platform,c.version=device.version,c.serial=device.serial,r.info("device platform:"+device.platform),"iOS"==c.os?c.type=1:"Android"==c.os?c.type=2:"WinCE"==c.os?c.type=3:c.type=100):r.error("undefined device");var s=o.getCurrentRegistrationID();null!=s&&""!==s?(c.hid=s,r.info("device hid:"+s)):r.error("can't get hid");var a=JSON.stringify(c);e({method:"POST",url:appConfig.API_SVC_URL+"/user/dynamic_login",data:{userLoginInfo:t,terminalInfo:a},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){r.info("dynamic login success")}).error(function(e){r.error("dynamic login failed"),r.error(e)})})}}}]),r.$inject=["$scope","$state","$log","$ionicLoading","loginService","userNetService","taskNetService"],o.$inject=["$ionicHistory","$q","$http","$log","$ionicLoading","deviceService","errorCodeService","httpErrorCodeService","userLoginInfoService","userNetService","jimService","debugHelpService","PlaygroundStartupService","utilConvertDateToString","taskNetService","NoticeMessageService","IMInterfaceService"]}(this);