!function(){"use strict";function e(e,n,r){var s={},t=function(){var t=e.defer();return r.getConversationList().then(function(e){for(var r=0;r<e.length;++r)s[e[r].id]=e[r];n.debug("current conversation cache :"+JSON.stringify(s)),t.resolve()},function(e){n.error(e),t.reject(e)}),t.promise},i=function(){var e=new Array;for(var n in s)null!=s[n]&&e.push(s[n]);return e},o=function(t){var i=e.defer();return r.addConversation(t).then(function(e){t.id=e,s[e]=t,i.resolve(e)},function(e){n.error(e),i.reject(e)}),i.promise},a=function(t){var i=e.defer();return r.updateConversation(t).then(function(e){s[t.id]=t,i.resolve()},function(e){n.error(e),i.reject(e)}),i.promise},c=function(t){var i=e.defer();return r.deleteConversation(t).then(function(e){s[t.id]=null},function(e){n.error(e),i.reject(e)}),i.promise},d=function(e,n){for(var r in s)if(s[r].userId===e&&s[r].cUserId==n)return s[r];return null},u=function(){var e=0;for(var n in s)e+=n.noReadMessages;return e};return{initService:t,getConversationList:i,addConversation:o,updateConversation:a,deleteConversation:c,getConversation:d,unReadMessageCount:u}}function n(e,n,r,s){var t={imMessage:{id:null,userId:"0",cUserId:"0",type:"text",message:null,time:null,isFromMe:0,sendState:0,ext:null},imConversation:{id:null,userId:"0",isTop:0,showHints:0,noReadMessages:0,cUserId:"0",cUserNickname:null,cUserLoginName:null,cUserAvatar:null,created:null,lastMessage:"",lastMessageTime:null}},i=function(n){var s=t[n];return null==s||""==s?(e.error("invalid table name"),null):r.createRow(n,null,s)},o=function(){return i("imMessage")},a=null,c=function(s){var t=n.defer();e.info("imMessageStorageService init -> userId:"+s),null!=s&&(a=s);var i=["CREATE TABLE IF NOT EXISTS imMessage(id  INTEGER PRIMARY KEY AUTOINCREMENT,userId text,cUserId text,type text,message text,time text,isFromMe integer,sendState integer,ext text)","CREATE TABLE IF NOT EXISTS imConversation(id  INTEGER PRIMARY KEY AUTOINCREMENT,userId text,isTop integer, showHints integer,noReadMessages integer,cUserId text,cUserNickname text, cUserLoginName text,cUserAvatar text, created text,lastMessage text,lastMessageTime text)"];return e.info("im message execute sql list:"+i[0]),e.info("im message execute sql list:"+i[1]),r.executeSqlList(i).then(function(){e.info("create im message tables success"),t.resolve()},function(n){e.error("create im message tables error: "+n.message),t.reject(n)}),t.promise},d=function(e,n){var s=t[e];if(null==s||""==s)throw"invalid table name";return r.addRecords(e,n,s)},u=function(e){return d("imMessage",e)},l=function(e,s){var t=n.defer();return r.getMaxValue("imMessage","id",null).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},g=function(e,s,i,o){var a=n.defer();return r.findRecordsEx("imMessage",'userId = "#userId#" and cUserId = "#cUserId#" and id <= #miniId# order by id desc limit #count#'.replace("#userId#",e).replace("#cUserId#",s).replace("#miniId#",i).replace("#count#",o),t.imMessage).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},f=function(e,n){return r.dropRecords("imMessage"," userId = '#userId#' and cUserId = '#cUserId#'".replace("#userId#",e).replace("#cUserId#",n))},m=function(n,s){var t={sendState:s};return e.info("update message[#message#] state[#state#]".replace("#message#",JSON.stringify(n)).replace("#state#",s)),r.updateData("imMessage","id = '#id#'".replace("#id#",n.id),t)},v=function(e){return r.dropRecords("imMessage","id='#id#'".replace("#id#",e.id))},I=function(e){return e.created=s.currentDate2String(),d("imConversation",e)},p=function(){return r.findRecordsEx("imConversation"," userId='#userId#'".replace("#userId#",a),t.imConversation)},M=function(e){return r.updateData("imConversation","userId = '#userId#' and cUserId = '#cUserId#'".replace("#userId#",e.userId).replace("#cUserId#",e.cUserId),e)},U=function(e){return r.dropRecords("imConversation","userId = '#userId#' and cUserId = '#cUserId#'".replace("#userId#",e.userId).replace("#cUserId#",e.cUserId))},C=function(e,n){r.findRecordsEx("imConversation"," userId='#userId#' and cUserId='#cUserId#'".replace("#userId#",a).replace("#cUserId#",n),t.imConversation)},S=function(){return i("imConversation")};return{initDB:c,newMessage:o,newConversation:S,addMessage:u,deleteMessage:v,updateMessageState:m,getMessageList:g,deleteMessageList:f,addConversation:I,getConversationList:p,updateConversation:M,deleteConversation:U,getMaxIdForMessage:l,searchConversation:C}}function r(e,n,r,s,t,i,o,a,c,d,u){var l={},g={},f=function(e,n){l[e]=n},m=function(e,n){g[e]=n},v=function(e){l[e]=null},I=function(e){g[e]=null},p=function(n){if(e.debug("receive im message"),"undefined"==typeof n.msg_type&&"undefined"==typeof n.contentType);else{var r={userId:o.cache.selfInfo.userId,type:"text",isFromMe:!1,sendState:1},s=null;"Android"==device.platform?(r.cUserId=n.fromID.split("_")[1],s=n.fromID.split("_")[0],r.message=n.content.text,r.time=a.getLocalTime(1e3*n.createTimeInSeconds)):(r.cUserId=n.from_id.split("_")[1],s=n.from_id.split("_")[0],r.message=n.msg_body.text,r.time=a.getLocalTime(1e3*n.create_time)),e.info("receive message:"+JSON.stringify(r)),t.addMessage(r).then(function(e){r.id=e;for(var n in l)null!=l[n]&&l[n].onReceiveMessage(r)},function(n){e.error(n)});var c=i.getConversation(r.userId,r.cUserId);if(null==c){e.debug("not find conversation:userId "+r.userId+" cUserId "+r.cUserId),c=t.newConversation(),c.userId=r.userId,c.cUserId=r.cUserId;var d=o.cache.userInfo[r.cUserId];null!=d?(e.debug("find cUserInfo:"+JSON.stringify(d)),c.cUserNickname=d.nickname,c.cUserLoginName=d.loginName,c.cUserAvatar=d.avatar,c.lastMessage=r.message,c.lastMessageTime=r.time,c.noReadMessages=1,i.addConversation(c).then(function(e){c.id=e;for(var n in g)g[n].onAddConversation(c)},function(n){e.error("add conversation failed:"+n)})):(e.debug("not find cUserInfo"),o.getUserInfo(r.cUserId,function(n){e.debug("getUserInfo from Server:"+JSON.stringify(n)),c.cUserNickname=n.nickname,c.cUserLoginName=n.loginName,c.cUserAvatar=n.avatar,c.lastMessage=r.message,c.lastMessageTime=r.time,c.noReadMessages=1,i.addConversation(c).then(function(e){c.id=e;for(var n in g)g[n].onAddConversation(c)},function(n){e.error("add Conversation failed:"+n)})},function(n){e.error("getUserInfo failed:userId(#userId#) error(#error#)".replace("#userId#",r.cUserId).replace("#error#",n))}))}else e.info("conversation:"+JSON.stringify(c)),c.noReadMessages++,i.updateConversation(c)}},M=function(n){var r=window.JMessage.openedMessage;e.info("on open message:"+JSON.stringify(r));var s={userId:o.cache.selfInfo.userId,type:"text",isFromMe:!1,sendState:1},d=null;"Android"==device.platform?(s.cUserId=n.fromID.split("_")[1],d=n.fromID.split("_")[0],s.message=n.content.text,s.time=a.getLocalTime(1e3*n.createTimeInSeconds)):(s.cUserId=n.from_id.split("_")[1],d=n.from_id.split("_")[0],s.message=n.msg_body.text,s.time=a.getLocalTime(1e3*n.create_time)),e.info("receive message:"+JSON.stringify(s));var u=i.getConversation(s.userId,s.cUserId);if(null==u){e.debug("not find conversation:userId "+s.userId+" cUserId "+s.cUserId),u=t.newConversation(),u.userId=s.userId,u.cUserId=s.cUserId;var l=o.cache.userInfo[s.cUserId];null!=l?(e.debug("find cUserInfo:"+JSON.stringify(l)),u.cUserNickname=l.nickname,u.cUserLoginName=l.loginName,u.cUserAvatar=l.avatar,u.lastMessage=s.message,u.lastMessageTime=s.time,u.noReadMessages=1,i.addConversation(u).then(function(e){u.id=e;for(var n in g)g[n].onAddConversation(u);c.gotoIM(s.cUserId)},function(n){e.error("add conversation failed:"+n)})):(e.debug("not find cUserInfo"),o.getUserInfo(s.cUserId,function(n){e.debug("getUserInfo from Server:"+JSON.stringify(n)),u.cUserNickname=n.nickname,u.cUserLoginName=n.loginName,u.cUserAvatar=n.avatar,u.lastMessage=s.message,u.lastMessageTime=s.time,u.noReadMessages=1,i.addConversation(u).then(function(e){u.id=e;for(var n in g)g[n].onAddConversation(u);c.gotoIM(s.cUserId)},function(n){e.error("add Conversation failed:"+n)})},function(n){e.error("getUserInfo failed:userId(#userId#) error(#error#)".replace("#userId#",s.cUserId).replace("#error#",n))}))}else e.info("conversation:"+JSON.stringify(u)),c.gotoIM(s.cUserId)},U={onSingleReceiveMessage:p,onOpenMessage:M};s.updateMessageNotifyCB(U);var C=function(r,t){var i=n.defer();return e.info("sendMessage: cUserId(#cUserId#) message(#message#)".replace("#cUserId#",r.userId).replace("#message#",t.message)),s.sendTextMessage(t.userId,r.loginName+"_"+t.cUserId,t.type,t.message,function(e){i.resolve()},function(n){e.error("sendMessage failed:"+JSON.stringify(n)),i.reject(n)}),i.promise},S=function(e){return s.enterConversation(e.loginName+"_"+e.userId)},y=function(e){return s.exitConversation(e.loginName+"_"+e.userId)},N=function(n){var s=n.aps.alert;if(e.debug("enter onOpenNotification:"+s),console.log("enter onOpenNotification:"+s),null!=s){var t=s.split(":")[0];console.log("onOpenNotification:"+t),o.getUserInfoByNickname(t).then(function(e){console.log("onOpenNotification get user info by nickname success"),console.log("get user info by nickname(#nickname#):".replace("#nickname#",t)+JSON.stringify(e)),r.go("main.im-detail",{cid:e.userId})},function(n){e.error("onOpenNotification failed:"+n)})}};return{registerMsgObserver:f,unregisterMsgObserver:v,registerConversationObserver:m,unregisterConversationObserver:I,sendMessage:C,enterConversation:S,exitConversation:y,onOpenNotification:N}}function s(e,n,r,s){var t=n.defer(),i=0,o=function(i){return s.initDB(i).then(function(){return r.initService()},function(e){var r=n.defer();return r.reject(e),r.promise}).then(function(){e.info("init im module success"),a(),t.resolve()},function(n){e.error("init imConversationService failed:"+n),t.reject()}),t.promise},a=function(){i=r.unReadMessageCount()};return{initService:o,unReadMessageCount:i}}angular.module("com.helporz.im.services",["com.helporz.jim.services","com.helporz.utils.service","app.user.utils.service"]).factory("imConversationService",e).factory("imMessageStorageService",n).factory("imMessageService",r).factory("IMInterfaceService",s).factory("dateService",[function(){return{handleMessageDate:function(e){var n=0,r=0,s={},t={},i=["周日","周一","周二","周三","周四","周五","周六"],o=0;if(!imConversations)return console.log("messages is null"),null;for(t=this.getNowDate(),r=imConversations.length,n=0;n<r;n++){if(s=this.getMessageDate(imConversations[n]),!s)return null;t.year-s.year>0?imConversations[n].lastMessage.time=s.year+"":t.month-s.month>=0||t.day-s.day>t.week?imConversations[n].lastMessage.time=s.month+"月"+s.day+"日":t.day-s.day<=t.week&&t.day-s.day>1?(o=t.week-(t.day-s.day),imConversations[n].lastMessage.time=i[o]):t.day-s.day!==1?t.day-s.day!==0||(imConversations[n].lastMessage.time=s.hour+":"+s.minute):imConversations[n].lastMessage.time="昨天"}},getNowDate:function(){var e={},n=new Date;return e.year=n.getFullYear(),e.month=n.getMonth(),e.day=n.getDate(),e.week=n.getDay(),e.hour=n.getHours(),e.minute=n.getMinutes(),e.second=n.getSeconds(),e},getMessageDate:function(e){var n={},r="",s=/(^\d{4})-(\d{1,2})-(\d{1,2})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/g,t=new Array;return e?(r=e.lastMessage.originalTime,(t=s.exec(r))?(n.year=parseInt(t[1]),n.month=parseInt(t[2]),n.day=parseInt(t[3]),n.hour=parseInt(t[4]),n.minute=parseInt(t[5]),n.second=parseInt(t[6]),n):(console.log("result is null"),null)):(console.log("message is null"),null)}}}]),e.$inject=["$q","$log","imMessageStorageService"],n.$inject=["$log","$q","dbService","UtilsService"],r.$inject=["$log","$q","$state","jimService","imMessageStorageService","imConversationService","userNetService","UtilsService","userUtils","IMInterfaceService","debugHelpService"],s.$inject=["$log","$q","imConversationService","imMessageStorageService"]}();