!function(){"use strict";function e(e,t,n,s,o,i,r,a){var c={isNearTaskNeedRefresh:!0,nearTaskList:[],postTaskList:[],acceptTaskList:[],isPostTaskGoingNeedRefresh:!0,postTaskGoingList:[],isPostTaskFinishNeedRefresh:!0,postTaskFinishList:[],isAcceptTaskGoingNeedRefresh:!0,acceptTaskGoingList:[],isAcceptTaskFinishNeedRefresh:!0,acceptTaskFinishList:[],nm_postGoing:[],nm_postFinish:[],nm_acceptGoing:[],nm_acceptFinish:[],nm_comment:[],nm_follow:[],nm_main_changed:!1,nm_task_changed:!1,nm_follow_changed:!1},u=function(e,t,s,o,i,r,a,c,u,p,l){var g=null==o?null:o.toLocaleString(),m=null==i?null:i.toLocaleString(),f={taskType:e,summary:t,pubLocation:s,startTime:g,deadLine:m,posterLong:r,posterLat:a,rewardType:c,rewardSubType:u,rewardCount:p,payMethodType:l};return n.postForPromise("/v2/task/post",f)},p=function(e){return n.postForPromise("/task/"+e+"/accept",null)},l=function(e){return n.postForPromise("/task/"+e+"/cancel_by_accepter",null)},g=function(e){return n.postForPromise("/task/"+e+"/cancel_by_poster",null)},m=function(e){return n.postForPromise("/task/"+e+"/complete",null)},f=function(e,t,s,o){var i={status:t,level:s,comment:o};return n.postForPromise("/task/"+e+"/confirm_by_poster",i)},k=function(t,s,o,i,r,a){var c=r.length,u=a.length,p={level:s,comment:o,tags:i,imgCount:c,audioCount:u},l=e.defer();return n.postForPromise("/task/"+t+"/comment_by_poster",p).then(function(t){var n=new Array;if(r.length>0)for(var s=0;s<r.length;++s){var o=T(vm.taskId,r[s]);null!=o&&n.push(o)}if(a.length>0)for(var i=0;i<a.length;++i){_(vm.taskId,a[i]);null!=o&&n.push(o)}n.length>0?e.all(n).then(function(){l.resolve()},function(){l.reject()}):l.resolve()},function(e){l.reject(e)}),l.promise},h=function(t,s,o,i,r,a){var c=r.length,u=a.length,p={level:s,comment:o,tags:i,imgCount:c,audioCount:u},l=e.defer();return n.postForPromise("/task/"+t+"/comment_by_accepter",p).then(function(t){var n=new Array;if(r.length>0)for(var s=0;s<r.length;++s){var o=d(vm.taskId,r[s]);null!=o&&n.push(o)}if(a.length>0)for(var i=0;i<a.length;++i){L(vm.taskId,a[i]);null!=o&&n.push(o)}n.length>0?e.all(n).then(function(){l.resolve()},function(){l.reject()}):l.resolve()},function(e){l.reject(e)}),l.promise},T=function(e,t){var n={Connection:"close","x-login-key":r.getLoginTicket()};return i.uploadImgFile(t,appConfig.API_SVC_URL+"/task/"+e+"/topic/img/true",n)},d=function(e,t){var n={Connection:"close","x-login-key":r.getLoginTicket()};return i.uploadImgFile(t,appConfig.API_SVC_URL+"/task/"+e+"/topic/img/false",n)},_=function(e,t){var n={Connection:"close","x-login-key":r.getLoginTicket()};return i.uploadImgFile(t,appConfig.API_SVC_URL+"/task/"+e+"/topic/audio/true",n)},L=function(e,t){var n={Connection:"close","x-login-key":r.getLoginTicket()};return i.uploadImgFile(t,appConfig.API_SVC_URL+"/task/"+e+"/topic/audio/false",n)},v=function(e,t){var s={};return null!=e&&e>0&&(s.beginTaskId=e),null!=t&&t>0&&(s.taskCount=t),n.getForPromise("/task/query/random/new",s)},P=function(e){return n.getForPromise("/task/"+e+"/detail",null)},F=function(e){if(c.nearTaskList){for(var t=0;t<c.nearTaskList.length;t++)if(c.nearTaskList[t].id==e)return c.nearTaskList[t];return null}return null},y=function(t){var n=e.defer();return P(t).then(function(e){n.resolve(e);for(var s in c.nearTaskList)(c.nearTaskList[s].id=t)&&(c.nearTaskList[s]=e);return n.promise},function(e){return n.reject(e),n.promise})},A=function(e){if(c.postTaskGoingList)for(var t=0;t<c.postTaskGoingList.length;t++)if(c.postTaskGoingList[t].id==e)return c.postTaskGoingList[t];if(c.postTaskFinishList)for(var t=0;t<c.postTaskFinishList.length;t++)if(c.postTaskFinishList[t].id==e)return c.postTaskFinishList[t];return null},S=function(e){if(c.acceptTaskGoingList)for(var t=0;t<c.acceptTaskGoingList.length;t++)if(c.acceptTaskGoingList[t].id==e)return c.acceptTaskGoingList[t];if(c.acceptTaskFinishList)for(var t=0;t<c.acceptTaskFinishList.length;t++)if(c.acceptTaskFinishList[t].id==e)return c.acceptTaskFinishList[t];return null},C=function(e,t){var s={pageIndex:e,pageSize:t};return n.getForPromise("/task/query/accepted",s)},N=function(t,s){var o={pageNum:t,pageSize:s},i=e.defer();return n.getForPromise("/task/query/accepted/completed",o).then(function(e){return i.resolve(e),c.isAcceptTaskFinishNeedRefresh=!1,c.acceptTaskFinishList=e,i.promise},function(e){return i.reject(e),i.promise})},E=function(){var t=e.defer();return n.getForPromise("/task/query/accepted/uncompleted",null).then(function(e){return t.resolve(e),c.isAcceptTaskGoingNeedRefresh=!1,c.acceptTaskGoingList=e,t.promise},function(e){return t.reject(e),t.promise})},G=function(e,t){var s={pageIndex:e,pageSize:t};return n.getForPromise("/task/query/posted",s)},R=function(t,s){var o={pageNum:t,pageSize:s},i=e.defer();return n.getForPromise("/task/query/posted/completed",o).then(function(e){return i.resolve(e),c.isPostTaskFinishNeedRefresh=!1,c.postTaskFinishList=e,i.promise},function(e){return i.reject(e),i.promise})},I=function(){var t=e.defer();return n.getForPromise("/task/query/posted/uncompleted").then(function(e){return t.resolve(e),c.isPostTaskGoingNeedRefresh=!1,c.postTaskGoingList=e,t.promise},function(e){return t.reject(e),t.promise})},M=function(){var t=e.defer();return n.getForPromise("/task/query").then(function(e){return t.resolve(e),c.isPostTaskGoingNeedRefresh=!1,c.isPostTaskFinishNeedRefresh=!1,c.isAcceptTaskGoingNeedRefresh=!1,c.isAcceptTaskFinishNeedRefresh=!1,c.postTaskGoingList=e.uncompletedPostList||[],c.postTaskFinishList=e.completedPostList||[],c.acceptTaskGoingList=e.uncompletedAcceptList||[],c.acceptTaskFinishList=e.completedAcceptList||[],ho.trace(e),t.promise},function(e){return t.reject(e),t.promise})},w=function(e,t){var s={comment:t};return n.postForPromise("/task/"+e+"/comment",s)},q=function(e){return n.getForPromise("/task/"+e+"/share_page",null)},b=function(e){t.debug("get waiting task list:"+e);var s={userId:e};return n.getForPromise("/task/query/status/waiting",s)},B=function(){a.getAllNoticeMessage().then(function(e){var t=c.nm_postGoing.length,n=c.nm_postFinish.length,s=c.nm_acceptGoing.length,o=c.nm_acceptFinish.length,i=c.nm_comment.length,r=c.nm_follow.length,u=c.nm_postGoing=[],p=c.nm_postFinish=[],l=c.nm_acceptGoing=[],g=c.nm_acceptFinish=[],m=c.nm_comment=[],f=c.nm_follow=[],k=a.getNoticeMessageTypes();if(null!=e&&e.length>0){for(var h=e,T=0;T<h.length;++T){var d=h[T];d.type==k.POSTER_UNCOMPLETED_TASK_MESSAGE_TYPE?u.push(d):d.type==k.ACCEPTER_UNCOMPLETED_TASK_MESSAGE_TYPE?l.push(d):d.type==k.COMMENT_TASK_MESSAGE_TYPE?m.push(d):d.type==k.FRIEND_TASK_MESSAGE_TYPE?f.push(d):d.type==k.POSTER_COMPLETED_TASK_MESSAGE_TYPE?p.push(d):d.type==k.ACCEPTER_COMPLETED_TASK_MESSAGE_TYPE&&g.push(d)}(u.length>t||m.length>i)&&(c.isPostTaskGoingNeedRefresh=!0),p.length>n&&(c.isPostTaskFinishNeedRefresh=!0),l.length>s&&(c.isAcceptTaskGoingNeedRefresh=!0),g.length>o&&(c.isAcceptTaskFinishNeedRefresh=!0),c.nm_main_changed=!0,c.nm_task_changed=!0,f.length>r&&(c.nm_follow_changed=!0)}},function(e){t.error(e)})},j=function(e){for(var t in c.nm_comment)if(c.nm_comment[t].correlationId==e){a.setReadFlagBySerialNo(c.nm_comment[t].serialNo),c.nm_comment.splice(t,1);break}},O=function(){var e={onNotify:B};a.registerObserver(e)};return{postTask:u,acceptTask:p,cancelByAcceptor:l,cancelByPoster:g,completeByAcceptor:m,confirmByPoster:f,commentByPoster:k,commentByAcceptor:h,queryTaskInfo:P,getAcceptTaskList:C,getCompletedAcceptTaskList:N,getUncompletedAcceptTaskList:E,getPostTaskList:G,getCompletedPostTaskList:R,getUncompletedPostTaskList:I,getTaskList:M,commentTask:w,getTaskSharePage:q,queryNewTaskList:v,uploadTaskCommentImgByPoster:T,uploadTaskCommentImgByAcceptor:d,uploadTaskCommentAudioByPoster:_,uploadTaskCommentAudioByAceptor:L,getWaitingTaskList:b,cache:c,getTaskInNearList:F,queryTaskInNearList:y,getTaskInPostList:A,getTaskInAcceptList:S,fetchNoticeMessage:B,observeNoticeMessage:O,setCommentReadFlag:j}}angular.module("com.helporz.task.netservice",[]).factory("taskNetService",["$q","$log","httpBaseService","errorCodeService","httpErrorCodeService","uploadService","userLoginInfoService","NoticeMessageService",e])}();