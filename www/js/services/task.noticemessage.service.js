!function(){"use strict";function e(e,r,t,s,o,n,a){var i=new Array,l=null,c={POSTER_UNCOMPLETED_TASK_MESSAGE_TYPE:1,ACCEPTER_UNCOMPLETED_TASK_MESSAGE_TYPE:2,COMMENT_TASK_MESSAGE_TYPE:3,FRIEND_TASK_MESSAGE_TYPE:4,POSTER_COMPLETED_TASK_MESSAGE_TYPE:5,ACCEPTER_COMPLETED_TASK_MESSAGE_TYPE:6},u=function(e){console.log(" index onOpenNotification");try{"undefined"!=typeof e._j_type&&"jmessage"===e._j_type?n.onOpenNotification(e):_(p(e))}catch(r){console.log("JPushPlugin:onOpenNotification"+r)}},d=function(r){e.info(" index onReceiveNotification:"+JSON.stringify(r));try{_(p(r))}catch(t){console.log(t)}},g=function(r){try{e.info("on receive push message:"+JSON.stringify(r)),_(p(r))}catch(t){console.log("JPushPlugin:onReceivePushMessage-->"+t)}},f=function(e){try{console.log("onSetTagsWithAlias");var r="result code:"+e.resultCode+" ";r+="tags:"+e.tags+" ",r+="alias:"+e.alias+" "}catch(t){console.log(t)}},p=function(e){var r={};return"Android"==device.platform?(r.alert=e.alert,r.userId=e.extras["cn.jpush.android.EXTRA"].userId,r.type=e.extras["cn.jpush.android.EXTRA"].type,r.correlationId=e.extras["cn.jpush.android.EXTRA"].correlation_id):(r.alert=e.aps.alert,r.userId=e.userId,r.type=e.type,r.correlationId=e.correlation_id),r},N=function(r){if(e.info("NoticeMessageService init"),null!=l&&l===r)return void e.info("NoticeMessageService 已经初始化了");l=r;var s={onOpenNotification:u,onReceiveNotification:d,onReceivePushMessage:g,onSetTagsWithAlias:f};o.setNotificationFn(s),o.getRegistrationID(),t.initDB(r)},_=function(t){e.info("enter on receive notice message list");var s=r.defer();return null==t.userId||null==l||t.userId!==l?void e.warn("收到非当前登录用户推送消息,当前用户Id#cId#,推送消息用户ID#uId#".replace("#cId#",l).replace("#uId#",t.userId)):(e.info("will call refresh notice message list"),m().then(function(r){e.debug("completed refresh notice message from server"),e.debug("observer count:"+i.length);for(var t=0;t<i.length;++t)i[t].onNotify();s.resolve(r)},function(e){s.reject(e)}),s.promise)},m=function(){var o=r.defer();return t.getMaxSerialNo().then(function(r){s.getUnreadMessageBySerialNo(r).then(function(s){if(null==s||0==s.length)o.resolve([]);else{e.debug("message length "+s.length);var n=s[0].serialNo;n>r?t.addNoticeMessages(n,s).then(function(e){o.resolve(e)},function(e){o.reject(e)}):o.resolve(s)}},function(e){o.reject(e)})},function(e){o.reject(e)}),o.promise},v=function(r){e.debug("register observer"),i.push(r)},S=function(){return c},E=function(e){var s=r.defer();return m().then(function(){t.getUnReadMessageByType(e).then(function(e){s.resolve(e)},function(e){s.reject(e)})}),s.promise},M=function(){var e=r.defer();return m().then(function(){t.getAllUnreadMessage().then(function(r){e.resolve(r)},function(r){e.reject(r)})}),e.promise},y=function(){var s=r.defer();return m().then(function(){t.getAllUnreadMessageEx(" correlationId desc ").then(function(r){var t=new Array,o=new Array,n=new Array,a=new Array,i=new Array,l=new Array,u=null,d=null,g=null,f=null,p=null;e.info("raw notice message length:"+r.length);for(var N=0;N<r.length;++N)if(r[N].type!=c.COMMENT_TASK_MESSAGE_TYPE)if(r[N].type==c.FRIEND_TASK_MESSAGE_TYPE&&l.push(r[N]),null==u&&(u=r[N].correlationId),u===r[N].correlationId)switch(r[N].type){case c.POSTER_UNCOMPLETED_TASK_MESSAGE_TYPE:null==d&&(g=r[N]);break;case c.POSTER_COMPLETED_TASK_MESSAGE_TYPE:d=r[N],g=null;break;case c.ACCEPTER_UNCOMPLETED_TASK_MESSAGE_TYPE:null==f&&(p=r[N]);break;case c.ACCEPTER_COMPLETED_TASK_MESSAGE_TYPE:f=r[N],p=null}else null!=d&&o.push(d),null!=g&&t.push(g),null!=f&&a.push(f),null!=p&&n.push(p),u=r[N].correlationId,d=null,g=null,f=null,p=null,--N;else i.push(r[N]);null!=d&&o.push(d),null!=g&&t.push(g),null!=f&&a.push(f),null!=p&&n.push(p);var _={uncompleted_post_task_message_list:t,completed_post_task_message_list:o,uncompleted_accept_task_message_list:n,completed_accept_task_message_list:a,comment_task_message_list:i,friend_task_message_list:l};s.resolve(_)},function(e){s.reject(e)})}),s.promise},I=function(e,r){return t.setReadFlagByCorrelationId(e,r)},h=function(e,r){return t.setReadFlagForLessAndEqualSerialNo(e,r)},T=function(e){return t.setReadFlagByType(e)},A=function(e){return t.setReadFlagBySerialNo(e)};return{initService:N,onReceiveNoticeMessageList:_,refreshNoticeMessageListFromServer:m,registerObserver:v,getNoticeMessageTypes:S,getNoticeMessage:E,getAllNoticeMessage:M,getAllNoticeMessageEx:y,setReadFlagByCorrelationId:I,setReadFlagForLessAndEqualSerialNo:h,setReadFlagByType:T,setReadFlagBySerialNo:A}}function r(e,r,t,s){var o={noticeMessage:{userId:"0",serialNo:"0",type:0,correlationId:"0",message:null,ext:null},userMaxNoticeSerialNo:{userId:"0",serialNo:"0"}},n=function(r,s){var n=o[r];return null==n||""==n?(e.error("invalid table name"),null):t.createRow(r,s,n)},a=function(r){var s=o[r];return null==s||""==s?(e.error("invalid table name"),null):t.createRow(r,null,s)},i=null,l=function(r){e.info("NoticeMessageDB init -> userId:"+r),null!=r&&(i=r);var s=["CREATE TABLE IF NOT EXISTS noticeMessage(userId text,serialNo text,type INTEGER,correlationId text,message text,ext text)","CREATE TABLE IF NOT EXISTS userMaxNoticeSerialNo(userId text, serialNo text)"];t.executeSqlList(s).then(function(){e.info("create notice message tables success")},function(r){e.error("create notice message tables error: "+r.message)})},c=function(){var s=r.defer();return t.findRecords("userMaxNoticeSerialNo",'userId = "'+i+'"').then(function(r){if(e.info("userMaxNoticeSerialNo success"),"undefined"==typeof r||null===r)return void s.resolve("0");if(0==r.rows.length)return void s.resolve("0");var t=n("userMaxNoticeSerialNo",r.rows.item(r.rows.length-1));e.info("getMaxSerialNo: userMaxNoticeSerialNo record count:"+r.rows.length),e.info("userMaxNoticeSerialNo:"+t.serialNo),s.resolve(t.serialNo)},function(r){e.error("getMaxSerialNo failed:"+r.message),s.reject()}),s.promise},u=function(s){var o=r.defer(),n=a("userMaxNoticeSerialNo");return n.userId=i,n.serialNo=s,t.saveRecords("userMaxNoticeSerialNo",(new Array).push(n)).then(function(e){o.resolve()},function(r){e.error("setMaxSerialNo failed:"+r.message),o.reject()}),o.promise},d=function(s,n){e.debug("addNoticeMessage maxSerialNo:"+s);for(var l=r.defer(),c=0;c<n.length;++c)n[c].userId=i;var u=t.getSaveRecordSql("noticeMessage",n,o.noticeMessage),d=a("userMaxNoticeSerialNo");d.userId=i,d.serialNo=s;var g=t.getSaveRecordSql("userMaxNoticeSerialNo",d,o.userMaxNoticeSerialNo),f=new Array;return f.push(g),f.push(u),t.executeSqlList(f).then(function(){l.resolve()},function(){l.reject()}),l.promise},g=function(e,s){var o=r.defer();return t.dropRecords("noticeMessage",'userId ="'+i+'" and type = "'+e+'" and serialNo <= "'+s+'"').then(function(e){o.resolve()},function(e){o.reject()}),o.promise},f=function(e,s){var o=r.defer();return t.dropRecords("noticeMessage",'userId ="'+i+'" and type = "'+e+'" and correlationId = "'+s+'"').then(function(e){o.resolve()},function(e){o.reject()}),o.promise},p=function(e,s){var o=r.defer();return t.dropRecords("noticeMessage",'userId ="'+i+'" and type = "'+e+'"').then(function(e){o.resolve()},function(e){o.reject()}),o.promise},N=function(e){var s=r.defer();return t.dropRecords("noticeMessage",'userId ="'+i+'" and serialNo = "'+e+'"').then(function(e){s.resolve()},function(e){s.reject()}),s.promise},_=function(e){var s=r.defer();return t.findRecordsEx("noticeMessage","userId='#uId#' and type=#tId#".replace("#uId#",i).replace("#tId#",e),o.noticeMessage).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},m=function(){var e=r.defer();return t.findRecordsEx("noticeMessage","userId='#uId#'".replace("#uId#",i),o.noticeMessage).then(function(r){e.resolve(r)},function(r){e.reject(r)}),e.promise},v=function(e){var s=r.defer(),n="userId='#uId#'".replace("#uId#",i)+" order by "+e;return t.findRecordsEx("noticeMessage",n,o.noticeMessage).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise};return{initDB:l,createRecord:a,getMaxSerialNo:c,setMaxSerialNo:u,addNoticeMessages:d,setReadFlagByCorrelationId:f,setReadFlagForLessAndEqualSerialNo:g,setReadFlagByType:p,setReadFlagBySerialNo:N,getUnReadMessageByType:_,getAllUnreadMessage:m,getAllUnreadMessageEx:v}}function t(e,r,t){var s=function(s){e.debug("getUnreadMessageBySerialNo:"+s);var o=r.defer(),n={serialNo:s};return t.getForPromise("/message/by_serial_no",n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise};return{getUnreadMessageBySerialNo:s}}function s(e,r){e.error("NoticeMessageServiceTest");var t=null,s={onNotify:function(){r.getAllNoticeMessageEx().then(function(r){if(null!=r.uncompleted_post_task_message_list){t=r.uncompleted_post_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}if(null!=r.completed_post_task_message_list){t=r.completed_post_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}if(null!=r.uncompleted_accept_task_message_list){t=r.uncompleted_accept_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}if(null!=r.completed_accept_task_message_list){t=r.completed_accept_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}if(null!=r.comment_task_message_list){t=r.comment_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}if(null!=r.friend_task_message_list){t=r.friend_task_message_list;for(var s=0;s<t.length;++s)e.info("noticemsg[#index#] type[#type#] serialNo[#serialNo#] correlationId[#correlationId#] message[#message#]".replace("#index#",s).replace("#type#",t[s].type).replace("#serialNo#",t[s].serialNo).replace("correlationId",t[s].correlationId).replace("message",t[s].message))}},function(r){e.error(r)})}};return r.registerObserver(s),s}angular.module("com.helporz.task.noticemessage",["com.helporz.utils.service","com.helporz.task.netservice","pusher"]).factory("NoticeMessageNetService",t).factory("NoticeMessageService",e).factory("NoticeMessageDB",r).factory("NoticeMessageServiceTest",s),e.$inject=["$log","$q","NoticeMessageDB","NoticeMessageNetService","pushService","imMessageService","debugHelpService"],r.$inject=["$log","$q","dbService","debugHelpService"],t.$inject=["$log","$q","httpBaseService"],s.$inject=["$log","NoticeMessageService"]}();